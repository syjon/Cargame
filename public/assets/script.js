document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ Skrypt za≈Çadowany!");

    // üîê Logowanie i rejestracja
    function handleFormSubmit(formId, url, messageId) {
        const form = document.getElementById(formId);
        if (!form) return;

        form.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch(url, { method: "POST", body: formData })
                .then(response => response.json())
                .then(data => {
                    console.log("üì° Odpowied≈∫ serwera:", data);
                    document.getElementById(messageId).innerText = data.message;
                    if (data.status === "success") setTimeout(() => location.reload(), 1000);
                })
                .catch(error => console.error("‚ùå B≈ÇƒÖd:", error));
        });
    }

    handleFormSubmit("loginForm", "login.php", "loginMessage");
    handleFormSubmit("registerForm", "register.php", "registerMessage");

    // üìÑ Dynamiczne ≈Çadowanie stron
    const pageButtons = {
        homeButton: "index.php",
        racesButton: "races.php",
        garageButton: "garage.php",
        shopButton: "shop.php",
        commissionButton: "commission.php",
        dealerButton: "dealer.php",
        workshopButton: "warsztat.php",
        fuelStationButton: "stacja.php",
        jobButton: "job.php",
        profileButton: "dashboard.php"
    };

    Object.keys(pageButtons).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) button.addEventListener("click", e => {
            e.preventDefault();
            loadPage(pageButtons[buttonId]);
        });
    });

    function loadPage(url) {
        const contentContainer = document.getElementById("main-content") || document.createElement("div");
        contentContainer.id = "main-content";
        document.body.appendChild(contentContainer);

        if (window.location.pathname.includes(url)) return;

        fetch(url + "?ajax=1")
            .then(response => response.ok ? response.text() : Promise.reject("B≈ÇƒÖd"))
            .then(html => {
                const tempContainer = document.createElement("div");
                tempContainer.innerHTML = html;
                const newContent = tempContainer.querySelector("#main-content") || tempContainer;
                contentContainer.innerHTML = newContent.innerHTML;

                setupGarageButtons();
				setupRaceFeatures();
                setupRaceForm(); // üèÅ Dodana obs≈Çuga formularza wy≈õcigu
            })
            .catch(error => console.error("‚ùå B≈ÇƒÖd ≈Çadowania strony:", error));
    }

    // üöó Wyb√≥r auta
    function setupGarageButtons() {
        window.selectCar = function (carId) {
            fetch("update_active_car.php", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `car_id=${encodeURIComponent(carId)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        alert("‚úÖ Wybrano auto!");
                        document.querySelectorAll(".select-car-btn").forEach(btn => btn.classList.remove("selected"));
                        document.querySelector(`[data-car-id='${carId}']`)?.classList.add("selected");
                    } else {
                        alert("‚ùå B≈ÇƒÖd: " + data.message);
                    }
                })
                .catch(error => console.error("‚ùå B≈ÇƒÖd wyboru auta:", error));
        };
    }

    // ‚õΩ Tankowanie
    window.refuelCar = function () {
        let fuelAmount = prompt("Ile litr√≥w paliwa chcesz zatankowaƒá?");
        
        if (!fuelAmount || isNaN(fuelAmount) || fuelAmount <= 0) {
            alert("‚ùå Nieprawid≈Çowa ilo≈õƒá paliwa.");
            return;
        }

        fetch("refuel.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "amount=" + encodeURIComponent(fuelAmount)
        })
        .then(response => response.json())
        .then(data => {
            console.log("üì° Odpowied≈∫ serwera:", data);
            if (data.status === "success") {
                document.getElementById("fuelStatus").innerText = data.new_fuel + " L";
                alert("‚úÖ Zatankowano " + fuelAmount + "L!");
            } else {
                alert("‚ùå B≈ÇƒÖd: " + data.message);
            }
        })
        .catch(error => {
            console.error("‚ùå B≈ÇƒÖd tankowania:", error);
            alert("‚ùå WystƒÖpi≈Ç b≈ÇƒÖd podczas tankowania!");
        });
    };

    document.addEventListener("click", function (event) {
        if (event.target && event.target.id === "refuelButton") {
            console.log("‚õΩ Klikniƒôto przycisk Zatankuj");
            refuelCar();
        }
    });

    // üìå Ukrywanie wy≈õcig√≥w poni≈ºej 5 lvl
    function checkLevelAndShowRaces() {
        fetch("get_user_level.php")
            .then(response => response.json())
            .then(data => {
                document.getElementById("racesButton").style.display = data.level < 5 ? "none" : "inline";
            })
            .catch(error => console.error("‚ùå B≈ÇƒÖd pobierania poziomu:", error));
    }
    checkLevelAndShowRaces();

    // üèÅ Obs≈Çuga formularza wy≈õcigu po za≈Çadowaniu strony
    function setupRaceForm() {
        const raceForm = document.getElementById("raceForm");

        if (!raceForm) {
            console.warn("‚ùå Formularz wy≈õcigu NIE zosta≈Ç znaleziony!");
            return;
        }

        console.log("‚úÖ Formularz wy≈õcigu znaleziony!");
        raceForm.addEventListener("submit", function (e) {
            e.preventDefault();
            console.log("üèÅ Klikniƒôto START wy≈õcigu!");

            let raceSelect = document.getElementById("raceSelect");
            let raceId = raceSelect?.value;

            if (!raceId) {
                alert("‚ùå Wybierz wy≈õcig!");
                return;
            }

            fetch("race_start.php", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "race_id=" + encodeURIComponent(raceId)
            })
            .then(response => response.json())
            .then(data => {
                console.log("üì° Odpowied≈∫ serwera:", data);
                alert(data.message);
                if (data.status === "success") {
                    const fuelStatus = document.getElementById("fuelStatus");
                    if (fuelStatus) fuelStatus.innerText = "Pozosta≈Çe paliwo: " + data.new_fuel + " L";
                }
            })
            .catch(error => {
                console.error("‚ùå B≈ÇƒÖd:", error);
                alert("‚ùå WystƒÖpi≈Ç problem z rozpoczƒôciem wy≈õcigu!");
            });
        });
    }
	window.startJob = function () {
    const jobSelect = document.querySelector("select[name='job_id']");
    if (!jobSelect) {
        alert("‚ùå Nie wybrano pracy!");
        return;
    }

    const jobId = jobSelect.value;

    fetch(`job_start.php?job_id=${jobId}`)
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.status === "success") {
                location.reload();
            }
        })
        .catch(error => {
            console.error("‚ùå B≈ÇƒÖd rozpoczƒôcia pracy:", error);
            alert("‚ùå WystƒÖpi≈Ç problem z rozpoczƒôciem pracy!");
        });
};
	//Ko≈Ñczenie pracy

window.finishRace = function () {
    fetch("race_finish.php")
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.status === "success") {
                location.reload();
            }
        })
        .catch(err => {
            console.error("‚ùå B≈ÇƒÖd:", err);
            alert("‚ùå Nie uda≈Ço siƒô odebraƒá nagrody.");
        });
};
// ‚è±Ô∏è Timer wy≈õcigu
function updateTimer() {
    let timerElement = document.getElementById("race_timer");

    if (!timerElement) {
        setTimeout(updateTimer, 1000);
        return;
    }

    let endTime = parseInt(timerElement.getAttribute("data-end"), 10);
    if (isNaN(endTime)) {
        console.error("‚ùå Nieprawid≈Çowa warto≈õƒá data-end:", timerElement.getAttribute("data-end"));
        return;
    }

    function refreshTimer() {
        let now = Math.floor(Date.now() / 1000);
        let remainingTime = endTime - now;

        if (remainingTime > 0) {
            let hours = Math.floor(remainingTime / 3600);
            let minutes = Math.floor((remainingTime % 3600) / 60);
            let seconds = remainingTime % 60;

            let timeString = (hours > 0 ? hours + "h " : "") +
                             (minutes > 0 ? minutes + "m " : "") +
                             seconds + "s";

            timerElement.innerText = "‚è≥ Pozosta≈Çy czas: " + timeString;
            setTimeout(refreshTimer, 1000);
        } else {
            timerElement.innerText = "‚úÖ Wy≈õcig zako≈Ñczony!";
        }
    }

    refreshTimer();
}

// Uruchomienie timera po za≈Çadowaniu dokumentu
document.addEventListener('DOMContentLoaded', updateTimer);
    // ‚è±Ô∏è Timer pracy
    function updateTimer() {
        let timerElement = document.getElementById("timer_job");

        if (!timerElement) {
            setTimeout(updateTimer, 1000);
            return;
        }

        let endTime = parseInt(timerElement.getAttribute("data-end"), 10);
        if (isNaN(endTime)) {
            console.error("‚ùå Nieprawid≈Çowa warto≈õƒá data-end:", timerElement.getAttribute("data-end"));
            return;
        }

        function refreshTimer() {
            let now = Math.floor(Date.now() / 1000);
            let remainingTime = endTime - now;

            if (remainingTime > 0) {
                let hours = Math.floor(remainingTime / 3600);
                let minutes = Math.floor((remainingTime % 3600) / 60);
                let seconds = remainingTime % 60;

                let timeString = (hours > 0 ? hours + "h " : "") +
                                 (minutes > 0 ? minutes + "m " : "") +
                                 seconds + "s";

                timerElement.innerText = "‚è≥ Pozosta≈Çy czas: " + timeString;
                setTimeout(refreshTimer, 1000);
            } else {
                timerElement.innerText = "‚úÖ Praca zako≈Ñczona!";
            }
        }

        refreshTimer();
    }
// üéÅ Odbieranie nagrody za wy≈õcig
window.finishRace = function () {
    fetch("race_finish.php")
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.status === "success") {
                location.reload();
            }
        })
        .catch(error => {
            console.error("‚ùå B≈ÇƒÖd:", error);
            alert("‚ùå Nie uda≈Ço siƒô odebraƒá nagrody!");
        });
};
function setupRaceFeatures() {
    const raceForm = document.getElementById("raceForm");
    const finishBtn = document.getElementById("finishRaceButton");

    // üèÅ Obs≈Çuga startu wy≈õcigu
    if (raceForm) {
        console.log("‚úÖ Formularz wy≈õcigu znaleziony!");
        raceForm.addEventListener("submit", function (e) {
            e.preventDefault();
            console.log("üèÅ Klikniƒôto START wy≈õcigu!");

            let raceSelect = document.getElementById("raceSelect");
            let raceId = raceSelect?.value;

            if (!raceId) {
                alert("‚ùå Wybierz wy≈õcig!");
                return;
            }

            fetch("race_start.php", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "race_id=" + encodeURIComponent(raceId)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === "success") {
                    location.reload();
                }
            })
            .catch(error => {
                console.error("‚ùå B≈ÇƒÖd:", error);
                alert("‚ùå WystƒÖpi≈Ç problem z rozpoczƒôciem wy≈õcigu!");
            });
        });
    } else {
        console.warn("‚ùå Formularz wy≈õcigu NIE zosta≈Ç znaleziony!");
    }

    // üéÅ Obs≈Çuga odbioru nagrody
    if (finishBtn) {
        finishBtn.addEventListener("click", function () {
            console.log("üéÅ Klikniƒôto odbierz nagrodƒô!");

            fetch("race_finish.php")
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.status === "success") {
                        location.reload();
                    }
                })
                .catch(err => {
                    console.error("‚ùå B≈ÇƒÖd:", err);
                    alert("‚ùå Nie uda≈Ço siƒô odebraƒá nagrody.");
                });
        });
    }
}

    setTimeout(updateTimer, 500);
	function setupRaceButton() {
    const finishBtn = document.getElementById("finishRaceButton");
    if (finishBtn) {
        finishBtn.addEventListener("click", finishRace);
    }
}

});
